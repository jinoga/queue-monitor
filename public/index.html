<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Tahoma', sans-serif; background: #f4f7f6; margin: 0; padding: 10px; }
        .container { max-width: 800px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #1a73e8; color: white; padding: 20px; text-align: center; }
        .status-bar { display: flex; justify-content: space-around; background: #333; color: white; padding: 8px; font-size: 0.8em; }
        .latest-call { background: #202124; color: #00e676; text-align: center; padding: 40px 20px; }
        .latest-call h2 { font-size: 4em; margin: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; padding: 20px; }
        .card { border: 2px solid #e8eaed; border-radius: 10px; padding: 15px; text-align: center; background: #fff; }
        .card h3 { color: #5f6368; margin: 0 0 10px 0; font-size: 0.9em; }
        .card .q-now { font-size: 2.2em; font-weight: bold; color: #1a73e8; }
        .tracker { padding: 20px; background: #e8f0fe; text-align: center; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 120px; font-size: 1.1em; text-align: center; }
        button { padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</h1></div>
        <div class="status-bar">
            <span>üåê ‡πÄ‡∏ß‡πá‡∏ö-DB: <span id="web-status">...</span></span>
            <span>ü§ñ ‡∏ö‡∏≠‡∏ó-Server: <span id="bot-status">...</span></span>
        </div>
        <div class="latest-call">
            <div style="font-size: 1em; color: #aaa;">‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</div>
            <h2 id="main-q">-</h2>
            <div id="main-c" style="color: #fff; margin-top: 5px;"></div>
        </div>

        <div class="tracker">
            <input type="text" id="input-q" placeholder="‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß">
            <button onclick="saveTrack()">üîî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
            <div id="track-msg" style="margin-top:10px; font-weight:bold;"></div>
        </div>

        <div id="grid" class="grid"></div>
        <div style="text-align: center; padding: 10px; font-size: 0.8em; color: #999;">
            ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="last-time">-</span>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ldkelubmmtkrfybapdpc.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_DRyKBA4GTwq0x-Q4EKY5og_JsCIF5xq';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let myQ = localStorage.getItem('myQ');

        async function updateData() {
            const { data: status } = await supabase.from('latest_status').select('*').single();
            const { data: snaps } = await supabase.from('queue_snapshots').select('*').order('created_at', {ascending: false}).limit(50);

            if (!status || !snaps) return;

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Health
            const webStatus = document.getElementById('web-status');
            const botStatus = document.getElementById('bot-status');
            webStatus.innerHTML = '<span style="color:#00ff00">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>';
            
            const diff = (new Date() - new Date(status.last_updated)) / 1000 / 60;
            if (diff > 2) {
                botStatus.innerHTML = '<span style="color:#ff5252">‡∏ö‡∏≠‡∏ó‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span>';
            } else {
                botStatus.innerHTML = status.bot_status === 'üü¢ Online' 
                    ? '<span style="color:#00ff00">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>' 
                    : '<span style="color:#ffab40">‡∏´‡∏•‡∏∏‡∏î/‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà</span>';
            }

            // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏¥‡∏ß‡∏´‡∏•‡∏±‡∏Å
            const top = snaps[0];
            document.getElementById('main-q').innerText = top.current_queue;
            document.getElementById('main-c').innerText = `‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${top.current_counter}`;
            document.getElementById('last-time').innerText = new Date(top.created_at).toLocaleTimeString();

            // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏¢‡∏Å‡∏ä‡πà‡∏≠‡∏á
            const counters = {};
            snaps.forEach(s => { if(!counters[s.current_counter]) counters[s.current_counter] = s.current_queue; });
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            Object.keys(counters).sort((a,b)=>a-b).forEach(c => {
                grid.innerHTML += `<div class="card"><h3>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${c}</h3><div class="q-now">${counters[c]}</div></div>`;
            });

            // 4. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            if (myQ) {
                const msg = document.getElementById('track-msg');
                if (top.current_queue == myQ) {
                    msg.innerHTML = `üéØ ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß ${myQ} ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£`;
                    msg.style.color = "red";
                    speak(`‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß ${myQ} ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`);
                } else {
                    msg.innerHTML = `‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ${myQ} (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠)`;
                    msg.style.color = "blue";
                }
            }
        }

        function saveTrack() {
            myQ = document.getElementById('input-q').value;
            localStorage.setItem('myQ', myQ);
            alert('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß ' + myQ);
            updateData();
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'th-TH';
            window.speechSynthesis.speak(utterance);
        }

        // Realtime Subscribe
        supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'latest_status' }, updateData).subscribe();
        
        if (myQ) document.getElementById('input-q').value = myQ;
        updateData();
        setInterval(updateData, 15000); // ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡πÄ‡∏ä‡πá‡∏Ñ Health ‡∏ó‡∏∏‡∏Å 15 ‡∏ß‡∏¥
    </script>
</body>
</html>
