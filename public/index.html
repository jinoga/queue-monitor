<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Tahoma', sans-serif; background: #f4f7f6; margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #1a73e8; color: white; padding: 20px; text-align: center; }
        .status-bar { display: flex; justify-content: space-around; background: #333; color: white; padding: 8px; font-size: 0.8em; }
        .latest-call { background: #202124; color: #00e676; text-align: center; padding: 40px 20px; border-bottom: 5px solid #1a73e8; }
        .latest-call h2 { font-size: 5em; margin: 0; text-shadow: 0 0 20px rgba(0,230,118,0.5); }
        .tracker { padding: 25px; background: #e8f0fe; text-align: center; border-bottom: 1px solid #ddd; }
        input { padding: 12px; border: 2px solid #1a73e8; border-radius: 8px; width: 140px; font-size: 1.2em; text-align: center; font-weight: bold; }
        button { padding: 12px 25px; background: #1a73e8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px; }
        .card { border: 2px solid #e8eaed; border-radius: 12px; padding: 20px; text-align: center; background: #fff; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card h3 { color: #5f6368; margin: 0 0 10px 0; font-size: 1em; }
        .card .q-now { font-size: 2.5em; font-weight: bold; color: #1a73e8; }
        .footer { text-align: center; padding: 15px; font-size: 0.8em; color: #999; background: #fafafa; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</h1></div>
        
        <div class="status-bar">
            <span>üåê Web-DB: <span id="web-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span></span>
            <span>ü§ñ Bot-Status: <span id="bot-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span></span>
        </div>

        <div class="latest-call">
            <div style="font-size: 1.2em; color: #aaa; margin-bottom: 10px;">üì£ ‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            <h2 id="main-q">-</h2>
            <div id="main-c" style="color: #fff; margin-top: 10px; font-size: 1.2em;"></div>
        </div>

        <div class="tracker">
            <input type="text" id="input-q" placeholder="‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
            <button onclick="saveTrack()">üîî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
            <div id="track-msg" style="margin-top:15px; font-size: 1.1em; font-weight:bold;"></div>
        </div>

        <div id="grid" class="grid"></div>
        
        <div class="footer">
            ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="last-time">-</span> | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß Real-time
        </div>
    </div>

    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö) ---
        const SUPABASE_URL = 'https://ldkelubmmtkrfybapdpc.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_DRyKBA4GTwq0x-Q4EKY5og_JsCIF5xq';
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ã‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô)
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let myQ = localStorage.getItem('myQ');
        let lastPlayedQ = null;

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
        async function updateDashboard() {
            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Ñ‡∏¥‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                const { data: status } = await supabase.from('latest_status').select('*').single();
                const { data: snaps } = await supabase.from('queue_snapshots').select('*').order('created_at', {ascending: false}).limit(40);

                if (!status || !snaps || snaps.length === 0) return;

                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Health (‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)
                const webStatusEl = document.getElementById('web-status');
                const botStatusEl = document.getElementById('bot-status');
                
                webStatusEl.innerHTML = '<b style="color:#00ff00">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥</b>';
                
                const diffMinutes = (new Date() - new Date(status.last_updated)) / 1000 / 60;
                if (diffMinutes > 3) {
                    botStatusEl.innerHTML = '<b style="color:#ff5252">‡∏ö‡∏≠‡∏ó‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</b>';
                } else {
                    botStatusEl.innerHTML = status.bot_status === 'üü¢ Online' 
                        ? '<b style="color:#00ff00">‡∏ö‡∏≠‡∏ó‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</b>' 
                        : '<b style="color:#ffab40">‡∏ö‡∏≠‡∏ó‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà</b>';
                }

                // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà)
                const top = snaps[0];
                const mainQEl = document.getElementById('main-q');
                if (mainQEl.innerText !== top.current_queue) {
                    mainQEl.innerText = top.current_queue;
                    document.getElementById('main-c').innerText = `‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${top.current_counter}`;
                    document.getElementById('last-time').innerText = new Date(top.created_at).toLocaleTimeString('th-TH');
                }

                // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Grid)
                const counters = {};
                snaps.forEach(s => { 
                    if(!counters[s.current_counter]) counters[s.current_counter] = s.current_queue; 
                });
                
                const gridEl = document.getElementById('grid');
                gridEl.innerHTML = '';
                Object.keys(counters).sort((a,b) => a-b).forEach(c => {
                    gridEl.innerHTML += `
                        <div class="card">
                            <h3>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${c}</h3>
                            <div class="q-now">${counters[c]}</div>
                        </div>`;
                });

                // 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á + ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                if (myQ) {
                    const msgEl = document.getElementById('track-msg');
                    if (top.current_queue == myQ) {
                        msgEl.innerHTML = `üéØ ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì [${myQ}] ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£`;
                        msgEl.style.color = "#d32f2f";
                        if (lastPlayedQ !== myQ) {
                            speak(`‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${myQ} ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`);
                            lastPlayedQ = myQ;
                        }
                    } else {
                        msgEl.innerHTML = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠... ‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ [${myQ}]`;
                        msgEl.style.color = "#1976d2";
                    }
                }
            } catch (err) {
                console.error("Fetch Error:", err);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
        function saveTrack() {
            const val = document.getElementById('input-q').value.trim();
            if (val) {
                myQ = val;
                localStorage.setItem('myQ', myQ);
                lastPlayedQ = null; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏ï‡∏£‡∏á
                alert('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: ' + myQ);
                updateDashboard();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'th-TH';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ---
        if (myQ) document.getElementById('input-q').value = myQ;

        // ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-time
        supabase.channel('queue_changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'latest_status' }, updateDashboard)
            .subscribe();

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        updateDashboard();
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ Health ‡∏ó‡∏∏‡∏Å 20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(updateDashboard, 20000);
    </script>
</body>
</html>
