<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå - ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #f0f2f5; color: #333; }
        .header { background: #0046ad; color: white; padding: 20px; text-align: center; }
        .status-bar { background: #333; color: #0f0; padding: 8px; font-size: 0.8em; display: flex; justify-content: space-around; }
        .main-display { background: #1a1a1a; color: #00ff41; padding: 30px; text-align: center; border-bottom: 5px solid #0046ad; }
        .main-display h2 { font-size: 5em; margin: 0; font-family: monospace; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Card ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ */
        .card { background: white; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
        .card-header { background: #e3f2fd; padding: 10px; font-weight: bold; color: #0046ad; border-bottom: 1px solid #bbdefb; }
        .card-body { padding: 15px; text-align: center; background: #fff; }
        .card-body b { font-size: 3em; color: #0046ad; display: block; }
        
        /* ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á */
        .history-list { background: #fafafa; padding: 10px; border-top: 1px dashed #ddd; flex-grow: 1; }
        .history-title { font-size: 0.75em; color: #888; margin-bottom: 5px; text-align: left; font-weight: bold; }
        .history-item { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee; font-size: 0.85em; }
        .history-item:last-child { border-bottom: none; }
        .history-q { font-weight: bold; color: #555; }
        .history-time { color: #999; font-size: 0.9em; }
        
        .tracker { background: #fff; padding: 20px; text-align: center; border-bottom: 1px solid #ddd; }
        input { padding: 10px; font-size: 1.1em; width: 140px; text-align: center; border: 2px solid #0046ad; border-radius: 8px; }
        button { padding: 11px 20px; background: #0046ad; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header"><h1>‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</h1></div>
    <div class="status-bar">
        <span>DB: <span id="s-web">...</span></span>
        <span>BOT: <span id="s-bot">...</span></span>
    </div>
    <div class="main-display">
        <div style="color:#888;">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <h2 id="q-big">-</h2>
        <div id="c-big" style="color:#fff;">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>
    <div class="tracker">
        <input type="text" id="iq" placeholder="‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß">
        <button onclick="window.setMyQ()">üîî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <div id="t-msg" style="margin-top:10px; font-weight:bold;"></div>
    </div>
    
    <div id="grid" class="grid"></div>

    <script>
    (function() {
        const URL = 'https://ldkelubmmtkrfybapdpc.supabase.co';
        const KEY = 'sb_publishable_DRyKBA4GTwq0x-Q4EKY5og_JsCIF5xq';
        const sb = window.supabase.createClient(URL, KEY);
        let myQ = localStorage.getItem('myQ'), spokenQ = null;

        async function update() {
            try {
                const { data: status } = await sb.from('latest_status').select('*').single();
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Snapshot ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á
                const { data: snaps } = await sb.from('queue_snapshots').select('*').order('created_at', {ascending: false}).limit(100);
                
                if (!status || !snaps) return;

                document.getElementById('s-web').innerText = 'ONLINE';
                const diff = (new Date() - new Date(status.last_updated)) / 1000 / 60;
                document.getElementById('s-bot').innerText = diff < 3 ? 'ONLINE' : 'OFFLINE';

                const top = snaps[0];
                document.getElementById('q-big').innerText = top.current_queue;
                document.getElementById('c-big').innerText = `‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${top.current_counter}`;

                // --- Logic ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ---
                const counters = {}; // { 1: [q1, q2, q3...], 2: [...] }
                snaps.forEach(s => {
                    const c = s.current_counter;
                    if (!counters[c]) counters[c] = [];
                    if (counters[c].length < 6) { // ‡πÄ‡∏Å‡πá‡∏ö 6 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (1 ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô + 5 ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)
                        counters[c].push({
                            q: s.current_queue,
                            time: new Date(s.created_at).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})
                        });
                    }
                });

                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                
                Object.keys(counters).sort((a,b)=>a-b).forEach(cId => {
                    const data = counters[cId];
                    const currentQ = data[0];
                    const history = data.slice(1); // ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà 2 ‡∏ñ‡∏∂‡∏á 6 ‡∏Ñ‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥

                    let historyHTML = '';
                    if (history.length > 0) {
                        historyHTML = `
                            <div class="history-list">
                                <div class="history-title">‚è± 5 ‡∏Ñ‡∏¥‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</div>
                                ${history.map(h => `
                                    <div class="history-item">
                                        <span class="history-q">${h.q}</span>
                                        <span class="history-time">${h.time}</span>
                                    </div>
                                `).join('')}
                            </div>`;
                    } else {
                        historyHTML = '<div class="history-list" style="color:#ccc; font-size:0.8em;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>';
                    }

                    grid.innerHTML += `
                        <div class="card">
                            <div class="card-header">‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${cId}</div>
                            <div class="card-body">
                                <div style="font-size:0.7em; color:#888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
                                <b>${currentQ.q}</b>
                                <div style="font-size:0.8em; color:#999;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${currentQ.time}</div>
                            </div>
                            ${historyHTML}
                        </div>`;
                });

                // ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
                if (myQ) {
                    const msg = document.getElementById('t-msg');
                    if (top.current_queue == myQ) {
                        msg.innerText = `üéØ ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß [${myQ}] ‡πÅ‡∏•‡πâ‡∏ß!`;
                        msg.style.color = "red";
                        if (spokenQ !== myQ) {
                            const sp = new SpeechSynthesisUtterance(`‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß ${myQ} ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`);
                            sp.lang = 'th-TH'; window.speechSynthesis.speak(sp);
                            spokenQ = myQ;
                        }
                    } else {
                        msg.innerText = `‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ [${myQ}] (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠)`;
                        msg.style.color = "blue";
                    }
                }
            } catch (e) { console.error(e); }
        }

        window.setMyQ = () => {
            myQ = document.getElementById('iq').value.trim();
            if(myQ) {
                localStorage.setItem('myQ', myQ); spokenQ = null;
                alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß " + myQ);
                update();
            }
        };

        sb.channel('q').on('postgres_changes', {event:'*', schema:'public', table:'latest_status'}, update).subscribe();
        update(); setInterval(update, 20000);
    })();
    </script>
</body>
</html>
