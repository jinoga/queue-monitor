<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS ‡∏¢‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö */
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { background: #1976D2; color: white; padding: 20px; text-align: center; }
        .latest-panel { background: #333; color: #00ff00; padding: 30px; text-align: center; font-size: 3em; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; padding: 20px; }
        .card { border: 1px solid #ddd; padding: 15px; border-radius: 10px; text-align: center; }
        .card h3 { margin: 0 0 10px 0; color: #1976D2; }
        .q-num { font-size: 2em; font-weight: bold; color: #2e7d32; }
        .btn { padding: 10px 20px; cursor: pointer; border-radius: 5px; border: none; background: #4caf50; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>üè¢ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</h1></div>
        <div class="latest-panel" id="mainQ">-</div>
        
        <div style="padding: 20px; text-align: center; background: #e3f2fd;">
            <input type="text" id="myQ" placeholder="‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" style="padding: 10px; font-size: 1.2em; width: 150px; text-align: center;">
            <button class="btn" onclick="trackQ()">üîî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
            <div id="trackStatus" style="margin-top: 10px; font-weight: bold;"></div>
        </div>

        <div id="counterGrid" class="grid"></div>
        <div style="text-align: center; padding: 10px; color: #888;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="updateTime">-</span></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ldkelubmmtkrfybapdpc.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_DRyKBA4GTwq0x-Q4EKY5og_JsCIF5xq';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let trackedNumber = localStorage.getItem('trackedQ') || null;

        async function init() {
            if (trackedNumber) document.getElementById('myQ').value = trackedNumber;
            fetchData();
            
            // Realtime Subscribe
            supabase.channel('any')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'latest_status' }, () => {
                    console.log("üîî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô!");
                    fetchData();
                }).subscribe();
        }

        async function fetchData() {
            // ‡∏î‡∏∂‡∏á Snapshot ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const { data: snaps } = await supabase.from('queue_snapshots').select('*').order('created_at', {ascending: false}).limit(50);
            if (!snaps || snaps.length === 0) return;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏£‡∏ß‡∏°
            document.getElementById('mainQ').innerText = snaps[0].current_queue;
            document.getElementById('updateTime').innerText = new Date(snaps[0].created_at).toLocaleTimeString();

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á
            const counters = {};
            snaps.forEach(s => {
                if (!counters[s.current_counter]) counters[s.current_counter] = s.current_queue;
            });

            const grid = document.getElementById('counterGrid');
            grid.innerHTML = '';
            Object.keys(counters).sort((a,b)=>a-b).forEach(c => {
                grid.innerHTML += `<div class="card"><h3>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${c}</h3><div class="q-num">${counters[c]}</div></div>`;
            });

            checkMyQueue(snaps);
        }

        function trackQ() {
            trackedNumber = document.getElementById('myQ').value.trim();
            if (trackedNumber) {
                localStorage.setItem('trackedQ', trackedNumber);
                alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß " + trackedNumber);
                fetchData();
            }
        }

        function checkMyQueue(snaps) {
            if (!trackedNumber) return;
            // ‡∏´‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (Logic ‡∏á‡πà‡∏≤‡∏¢‡πÜ: ‡∏î‡∏π‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á)
            const latest = snaps[0].current_queue;
            const statusDiv = document.getElementById('trackStatus');
            
            if (latest == trackedNumber) {
                statusDiv.innerHTML = "üéØ ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß!";
                statusDiv.style.color = "red";
                playVoice("‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß " + trackedNumber + " ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
            } else {
                statusDiv.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠... (‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: " + latest + ")";
                statusDiv.style.color = "blue";
            }
        }

        function playVoice(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'th-TH';
            window.speechSynthesis.speak(msg);
        }

        init();
    </script>
</body>
</html>
