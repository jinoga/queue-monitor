<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; color: #333; }
        .header { background: #1a73e8; color: white; padding: 20px; text-align: center; }
        .main-card { background: #202124; color: #00e676; margin: 20px; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .main-card h2 { font-size: 5em; margin: 10px 0; }
        .status-bar { display: flex; justify-content: space-around; background: #333; color: #ccc; padding: 10px; font-size: 0.8em; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid #1a73e8; }
        .card b { font-size: 2em; color: #1a73e8; }
        .tracker { text-align: center; padding: 20px; background: #e8f0fe; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; width: 100px; text-align: center; font-size: 1.1em; }
        button { padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header"><h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</h1></div>
    <div class="status-bar">
        <span>DB: <span id="s-web">...</span></span>
        <span>BOT: <span id="s-bot">...</span></span>
    </div>
    <div class="main-card">
        <div style="color: #aaa;">‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <h2 id="q-big">-</h2>
        <div id="c-big">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>
    <div class="tracker">
        <input type="text" id="iq" placeholder="‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß">
        <button onclick="window.setMyQ()">üîî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <div id="t-msg" style="margin-top:10px; font-weight:bold;"></div>
    </div>
    <div id="grid" class="grid"></div>

    <script>
    // ‡∏´‡∏∏‡πâ‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Scope ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
    (function() {
        const URL = 'https://ldkelubmmtkrfybapdpc.supabase.co';
        const KEY = 'sb_publishable_DRyKBA4GTwq0x-Q4EKY5og_JsCIF5xq';
        const sb = window.supabase.createClient(URL, KEY);

        let myQ = localStorage.getItem('myQ');
        let spokenQ = null;

        async function update() {
            try {
                const { data: status } = await sb.from('latest_status').select('*').single();
                const { data: snaps } = await sb.from('queue_snapshots').select('*').order('created_at', {ascending: false}).limit(30);
                
                if (!status || !snaps) return;

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                document.getElementById('s-web').innerHTML = '<b style="color:#00ff00">ONLINE</b>';
                const diff = (new Date() - new Date(status.last_updated)) / 1000 / 60;
                document.getElementById('s-bot').innerHTML = diff < 3 ? '<b style="color:#00ff00">ONLINE</b>' : '<b style="color:#ff4444">OFFLINE</b>';

                // ‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏ç‡πà
                const top = snaps[0];
                document.getElementById('q-big').innerText = top.current_queue;
                document.getElementById('c-big').innerText = "‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà " + top.current_counter;

                // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏¢‡∏Å‡∏ä‡πà‡∏≠‡∏á
                const counts = {};
                snaps.forEach(s => { if(!counts[s.current_counter]) counts[s.current_counter] = s.current_queue; });
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                Object.keys(counts).sort((a,b)=>a-b).forEach(c => {
                    grid.innerHTML += `<div class="card"><div>‡∏ä‡πà‡∏≠‡∏á ${c}</div><b>${counts[c]}</b></div>`;
                });

                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                if (myQ) {
                    const msg = document.getElementById('t-msg');
                    if (top.current_queue == myQ) {
                        msg.innerHTML = "üéØ ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß!";
                        msg.style.color = "red";
                        if (spokenQ !== myQ) {
                            const speech = new SpeechSynthesisUtterance("‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß " + myQ + " ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
                            speech.lang = 'th-TH';
                            window.speechSynthesis.speak(speech);
                            spokenQ = myQ;
                        }
                    } else {
                        msg.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: " + myQ;
                        msg.style.color = "blue";
                    }
                }
            } catch (e) { console.log(e); }
        }

        window.setMyQ = function() {
            myQ = document.getElementById('iq').value;
            localStorage.setItem('myQ', myQ);
            spokenQ = null;
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß " + myQ);
            update();
        };

        sb.channel('db').on('postgres_changes', { event: '*', schema: 'public', table: 'latest_status' }, update).subscribe();
        update();
        setInterval(update, 20000);
    })();
    </script>
</body>
</html>
