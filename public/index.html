<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f8f9fa; }
        .header { background: #0046ad; color: white; padding: 20px; text-align: center; }
        .status-bar { background: #333; color: #0f0; padding: 10px; font-size: 0.8em; display: flex; justify-content: space-around; }
        .main-display { background: #1a1a1a; color: #00ff41; padding: 40px; text-align: center; border-bottom: 5px solid #0046ad; }
        .main-display h2 { font-size: 5.5em; margin: 0; font-family: 'Courier New', monospace; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        .card b { font-size: 2.4em; color: #0046ad; display: block; margin: 5px 0; }
        .card .dur { font-size: 0.75em; color: #d81b60; font-weight: bold; }
        .tracker { background: #e3f2fd; padding: 25px; text-align: center; border-bottom: 1px solid #ccc; }
        input { padding: 12px; font-size: 1.2em; width: 150px; text-align: center; border: 2px solid #0046ad; border-radius: 8px; }
        button { padding: 12px 25px; background: #0046ad; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header"><h1>‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</h1></div>
    <div class="status-bar">
        <span>DATABASE: <span id="s-web">...</span></span>
        <span>BOT-SSE: <span id="s-bot">...</span></span>
    </div>
    <div class="main-display">
        <div style="color:#888; font-size:1.2em;">‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</div>
        <h2 id="q-big">-</h2>
        <div id="c-big" style="color:#fff; font-size:1.4em;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>
    <div class="tracker">
        <input type="text" id="iq" placeholder="‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß">
        <button onclick="window.setMyQ()">üîî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <div id="t-msg" style="margin-top:10px; font-weight:bold;"></div>
    </div>
    <div id="grid" class="grid"></div>

    <script>
    (function() {
        const URL = 'https://ldkelubmmtkrfybapdpc.supabase.co';
        const KEY = 'sb_publishable_DRyKBA4GTwq0x-Q4EKY5og_JsCIF5xq';
        const sb = window.supabase.createClient(URL, KEY);
        let myQ = localStorage.getItem('myQ'), spokenQ = null;

        async function update() {
            try {
                const { data: status } = await sb.from('latest_status').select('*').single();
                const { data: snaps } = await sb.from('queue_snapshots').select('*').order('created_at', {ascending: false}).limit(40);
                if (!status || !snaps) return;

                document.getElementById('s-web').innerText = 'CONNECTED';
                const diff = (new Date() - new Date(status.last_updated)) / 1000 / 60;
                document.getElementById('s-bot').innerText = diff < 3 ? status.bot_status : 'OFFLINE';

                const top = snaps[0];
                document.getElementById('q-big').innerText = top.current_queue;
                document.getElementById('c-big').innerText = `‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${top.current_counter}`;

                const counts = {};
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                
                snaps.forEach(s => {
                    if (!counts[s.current_counter]) {
                        counts[s.current_counter] = true;
                        const time = new Date(s.created_at).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                        const durText = s.duration_seconds ? `<div class="dur">‚è± ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ä‡πâ: ${Math.floor(s.duration_seconds/60)} ‡∏ô‡∏≤‡∏ó‡∏µ</div>` : '<div class="dur">‚è± ‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏£‡∏Å</div>';
                        grid.innerHTML += `<div class="card">
                            <div style="font-size:0.8em; color:#666;">‡∏ä‡πà‡∏≠‡∏á ${s.current_counter} | ${time}</div>
                            <b>${s.current_queue}</b>${durText}
                        </div>`;
                    }
                });

                if (myQ) {
                    const msg = document.getElementById('t-msg');
                    if (top.current_queue == myQ) {
                        msg.innerText = `üéØ ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß [${myQ}] ‡πÅ‡∏•‡πâ‡∏ß!`;
                        msg.style.color = "red";
                        if (spokenQ !== myQ) {
                            const sp = new SpeechSynthesisUtterance(`‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß ${myQ} ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`);
                            sp.lang = 'th-TH'; window.speechSynthesis.speak(sp);
                            spokenQ = myQ;
                        }
                    } else {
                        msg.innerText = `‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${myQ} (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠)`;
                        msg.style.color = "blue";
                    }
                }
            } catch (e) {}
        }

        window.setMyQ = () => {
            myQ = document.getElementById('iq').value;
            localStorage.setItem('myQ', myQ); spokenQ = null;
            update();
        };

        sb.channel('q').on('postgres_changes', {event:'*', schema:'public', table:'latest_status'}, update).subscribe();
        update(); setInterval(update, 20000);
    })();
    </script>
</body>
</html>
